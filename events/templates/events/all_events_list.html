{% extends 'includes/base.html' %}
{% load static %}
{% load friendshiptags %}

{% block head_title %}Events{% endblock %}

{% block post_CSS %}
<link rel="stylesheet" href="{% static 'events/css/events.css' %}">
{% endblock %}

{% block content %}
<section class="light-page screen-height section-with-padding">
    <div class="nav-top-padding"></div>
    <div class="container-fluid w-100 m-auto py-5 px-0 centered-col-large-page">
        <h1 class="header-underline-after">Find Freelancer Meetups</h1>
        <div class="search-row py-5">
            <div class="card search-box-card muted">
                <h2>Filter your search</h2>
                <form action="{% url 'event_listings' %}" id="event_search_form" method="POST">{%csrf_token%}
                    <div class="input-row d-flex justify-content-between mt-3">
                        <div class="fieldset">
                            <label for="user_search" class="mb-3">By Keyword</label>
                            <input type="text" name="event_search" id="event_search"
                                placeholder="Search by name, location, skill, description">
                        </div>
                        <div class="fieldset" id="industry_search">
                            <label for="industry" class="mb-3">By Industry</label>
                            <div id="ind_select_profile_edit"></div>
                        </div>
                    </div>
                    <div class="d-flex search-button-wrapper justify-content-between flex-wrap">
                        <button type="submit" class="btn primary-btn large">Filter Results</button>
                        <a href="{% url 'event_listings' %}" class="btn primary-btn-outline-color">Clear Results</a>
                    </div>
                </form>
            </div>
        </div>


        <div id="search_results" class="page-results flex-wrap">
            {% for event in events %}
            <div class="card event-card muted">
                <div class="event-header-img">
                    <img class="" src="/media/{{event.header_image}}" alt="{{event.title}} - header image"
                        onload="specImageOrientation(this);">
                    <span class="card-title-overlay"></span>
                    <h3 class="event-card-title">{{event.title}}</h3>
                </div>
                <div class="d-flex flex-wrap">
                    <!-- TODO remove default testing input -->
                    <div class="event-details-mast p-0 m-auto text-center">
                        <span class="ind-pill">{{event.industry}}</span>
                        <p class="d-inline">{{event.location}}</p>
                        <p class="event-datetime d-block mt-2 text-center">
                            <strong>{{event.start_datetime|date:"f a"}}</strong> on
                            <strong>{{event.start_datetime|date:"d M Y"}}</strong>
                            ({{event.timezone}})
                        </p>
                        {% if event.timezone != this_user.timezone%}
                        <span class="timezone-warning"><em>This event doesn't occur in your chosen timezone!</em></span>
                        {% endif %}
                    </div>
                </div>
                <hr>
                <div class="event-details-bottom">
                    <p class="event-skills white-space">{{event.description}}</p>
                </div>
                <hr>
                <div class="event-card-buttons">
                    <button class="view-attendees-btn btn primary-btn px-3 py-1 m-1" data-bs-toggle="modal"
                        data-bs-target="#view_event_{{event.pk}}" value="{{event.pk}}"><i class="fas fa-eye"></i>
                        Attendees</button>

                    {%if this_user in event.registrants.all %}
                    <button class="remove-reg-btn btn primary-btn-outline-color px-3 py-1 m-1 w-45"
                        onclick="event_cancel('{{event.pk}}')" value="{{event.pk}}"><i
                            class="fas fa-check"></i>Registered</button>
                    {% else %}
                    <button class="register-btn btn primary-btn-outline-color px-3 py-1 m-1 w-45"
                        onclick="event_register('{{event.pk}}')" value="{{event.pk}}"><i
                            class="fas fa-clipboard"></i>Register</button>
                    {% endif %}

                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="fixed-40"></div>

    <!-- View Event Modal START -->
    {%for event in events%}
    <div class="modal event-view fade" id="view_event_{{event.pk}}" tabindex="-1" role="dialog"
        aria-labelledby="view_event_{{event.pk}}" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body p-0">
                    <span class="d-flex" data-bs-dismiss="modal" aria-label="Close"><i
                            class="fas fa-times ml-auto "></i></span>
                    <div class="event-card muted m-0 pt-0">
                        <div class="event-header-img">
                            <img class="" src="/media/{{event.header_image}}" alt="{{event.title}} - header image"
                                onload="specImageOrientation(this);">
                            <span class="card-title-overlay"></span>
                            <h3 class="event-card-title">{{event.title}}</h3>
                        </div>
                        <div class="event-details-bottom">
                            <h4>Registered Attendees ({{event.registrants.all.count}})</h4>
                            <hr>

                            <!-- List registered attendees -->
                            <div class="pending-requests-to-me">
                                
                                {% for reg in event.registrants.all %}
                                <div class="attendee-item-item flex-row flex-wrap" value="{{new_connection.pk}}">
                                    <div
                                        class="img-and-details-mast d-flex col-xl-8 col-lg-12 col-12 flex-column flex-sm-row">
                                        <div class="thumbnail-wrapper prf-img-preview-wrapper m-auto">
                                            <img class="prf-img-preview" src="/media/{{reg.profile_image}}"
                                                alt="{{new_connection.first_name}} {{new_connection.last_name}}'s' profile image"
                                                onload="specImageOrientation(this);">
                                        </div>
                                        <div
                                            class="new-req-details d-flex flex-column text-xl-start text-lg-start text-sm-start text-center">
                                            <p>{{reg.first_name}} {{reg.last_name}}
                                            </p>
                                            <p>{{reg.job_role}}
                                                <span class="ind-pill">{{reg.industry}}</span>
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Action buttons -->
                                    <div class="connection-action-btns col-xl-4">
                                        {% if pending_friend_reqs %}
                                        {% for conn_req in pending_friend_reqs %}
                                        {% if conn_req.to_user == reg %}
                                        <button class="req-sent-btn btn primary-btn px-3 py-1 m-1"
                                            onclick="cancel_friend('{{reg.pk}}')" value="{{reg.pk}}">Connection Request
                                            Sent</button>
                                        {% elif conn_req.to_user == this_user %}
                                        <button class="accept-conn-btn btn primary-btn conn-response-btn"
                                            onclick="accept_friend('{{reg.pk}}')" value="{{reg.pk}}" data-toggle="tooltip">
                                            <i class="fas fa-check"></i>
                                            <span class="tooltip-top">Accept the request</span>
                                        </button>
                                        <button class="decline-conn-btn btn primary-btn conn-response-btn warning"
                                            onclick="decline_friend('{{reg.pk}}')"
                                            value="{{reg.pk}}">
                                            <i class="fas fa-times"></i>
                                            <span class="tooltip-top">Decline the request</span>
                                        </button>
                                        {% endif %}
                                        {% endfor %}
                                        {% elif reg in current_connections %}
                                        <button class="remove-connection-btn btn primary-btn px-3 py-1 m-1"
                                            onclick="remove_friend('{{reg.pk}}')" value="{{reg.pk}}"><i class="fas fa-user"></i>Already Connected</button>
                                        {% else %}

                                        <button class="send-connection-btn btn primary-btn px-3 py-1 m-1"
                                            onclick="add_friend('{{reg.pk}}')" value="{{reg.pk}}">Send Connection
                                            Request</button>
                                        {% endif %}
                                    </div>

                                </div>

                                {% endfor %}
                            </div>
                        </div>
                        <div class="action-btns d-flex">
                        </div>
                    </div>
                </div>
                <div class="modal-footer flex-row">

                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    <!-- View Event Modal END -->

</section>

{{ industries|json_script:"all_inds" }}
<script src="{% static 'users/js/options_multiselect.js' %}" type="text/javascript"></script>
<script src="{% static 'events/js/events.js' %}" type="text/javascript"></script>


{% endblock %}